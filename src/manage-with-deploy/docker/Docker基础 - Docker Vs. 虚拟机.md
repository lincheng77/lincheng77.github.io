# Docker基础 - Docker Vs. 虚拟机

> 人们为了提高系统及硬件资源的利用率而引入了**虚拟化技术**。虚拟化是一种**资源管理技术**，它可以把各种实体资源抽像后再分隔，从而打破实体结构的限制，最大程度的提高资源的利用率。**Docker属于软件虚拟化技术中的操作系统层虚拟化技术**，它是基于LXC实现的一个应用容器引擎，Docker让开发者可以打包他们的应用及依赖环境到一个可移植的容器中，然后可以将这个容器快速部署到开发、测试或生产环境中。

## 什么是虚拟化技术？

### 什么是虚拟化

在计算机技术中，虚拟化（Virtualization）是一种资源管理技术。它是将计算机的各种实体资源（比如服务器、网络、内存、存储等）予以抽象，转换后呈现出来，打破实体结构间的不可分割的障碍，使用户可以用更好的方式利用这些资源。

虚拟化的目的是为了在同一个主机上运行多个系统或应用，从而提高系统资源的利用率，并带来降低成本，方便管理和容错容灾等好处。

### 虚拟化技术分类

从实现形式来分，虚拟化技术可以分为**基于硬件的虚拟化**和**基于软件的虚拟化**。

#### 硬件虚拟化

硬件虚拟化就是硬件物理平台本身提供了对特殊指令的截获和重定向的支持。支持虚拟化的硬件，也是一些**基于硬件实现软件虚拟化技术**的关键。在基于硬件实现软件虚拟化的技术中，硬件是实现虚拟化的基础，硬件（主要是CPU）会为虚拟化提供支持，从而实现硬件资源的虚拟化。

支持虚拟化的硬件有：

- Intel-VT（Intel Virtualization Technology），Intel公司为解决纯软件虚拟化引进的技术（纯软件虚拟化解决方案在可靠性、安全性、性能上均不足）。它可以让一个CPU工作起来像多个CPU在并行运行，从而使得在一部电脑内同时运行多个操作系统成为可能。
- AMD-V（AMD Virtualization），AMD公司的虚拟化技术。它是对x86处理器系统架构的一组硬件扩展和硬件辅助虚拟化技术，可以简化纯软件虚拟化这种虚拟化方案，改进VMM（虚拟机监视器）的设计，更充分地利用硬件资源，提高服务器和数据中心的虚拟化效率。

#### 软件虚拟化

软件虚拟化就是利用软件技术，在现有的物理平台上实现对物理平台访问的截取和模拟，在软件虚拟化技术中，有些技术不需要硬件支持，如：QEMU; 而有些软件虚拟化技术，则依赖硬件支持，如：VMware、KVM。

- 完全虚拟化（Full Virtualization），虚拟机模拟完整的底层硬件环境和特权指令的执行过程，使客户机操作系统可以独立运行。支持完全虚拟化的软件有：Parallels Workstation、VirtualBox、Virtual Iron、Oracle VM、Virtual PC、Virtual Server、Hyper-V、VMware Workstation、QEMU等。
- 硬件辅助虚拟化（Hardware-assisted Virtualization），是指通过硬件辅助支持模拟运行环境，使客户机操作系统可以独立运行，实现完全虚拟化的功能。支持硬件辅助虚拟化的软件有：Linux KVM、VMware Workstation、VMware Fusion、Virtual PC、Xen、VirtualBox、Parallels Workstation等。
- 部分虚拟化（Partial Virtualization），只针对部分硬件资源进行虚拟化，虚拟机模拟部分底层硬件环境，特别是地址空间。这样的环境支持资源共享和线程独立，但是不允许建立独立的客户机操作系统。
- 平行虚拟化（Para-Virtualization），虚拟机不需要模拟硬件，而是将部分硬件接口以软件的形式提供给客户机操作系统。如：早期的Xen。
- 操作系统层虚拟化（OS-level Virtualization），这种技术将操作系统内核虚拟化，可以允许使用者或者空间软件实例被分割成几个独立的单元，在内核中运行，而不是只有一个单一实例运行。这个软件实例也被称为是一个容器（containers）、虚拟引擎（Virtualization engine）、虚拟专用服务器（Virtual Private servers）。每个容器的进程是独立的，相对于使用者来说，就像是在使用自己的专用服务器。<u>**Docker容器**</u>技术就是是属于操作系统层虚拟化的范畴。

### 几种虚拟化技术

虚拟化是通过软件的方式模拟实体服务器，其初衷是为了解决“一种应用占用一台服务器”模式所带来的服务器数量剧增的问题，从而降低数据中心复杂度，简化管理难度。在虚拟化的发展过程中，出现过以下主要虚拟化技术或产品：

- **Xen**：由剑桥大学开发的，一款开源的虚拟机监视器。采用ICA协议，它通过一种叫做准虚拟化的技术来获取高性能，甚至在一些与传统虚拟技术极度不友好的架构上（如：x86），Xen也有极佳的表现。Xen属于半虚拟化的技术，所以其性能损失非常小。Xen没有指令翻译，其或者使用使能理解和翻译虚拟操作系统发出的未修改指令的CPU（即：完全虚拟化）；或者修改操作系统，使它发出的指令最优化，便于在虚拟化环境中执行（即：准虚拟化）。
- **KVM** ：KVM是一个Linux kernel模块，可以使用modprobe来加载KVM，加载后还需要通过其他工具创建虚拟机。KVM是一个全虚拟化的解决方案，但需要CPU支持虚拟化功能。相比Xen来说，KVM可以更加方便的整合进Linux内核，但它还需要其它虚拟化软件（如：QEMU）才能实现虚拟化功能。
- **LXC**：Linux Container，Linux容器，是一种轻量级的虚拟化的手段。它可以提供轻量级的虚拟化，以隔离进程和资源，而且不需要提供指令解释机制以及全虚拟化的其他复杂性。容器会有效地将由单个操作系统管理的资源划分到孤立的组中，以更好地在孤立的组之间平衡有冲突的资源使用需求。
- **OpenVZ**：是SWsoft公司开发的开源软件，是该公司Virtuozzo软件的基础产品，是基于Linux平台的操作系统级服务器虚拟化解决方案。通过OpenVZ，可以在单个物理服务器上创建多个相互隔离的虚拟专用服务器(VPS)并以最大的效率共享硬件和管理资源。其上运行虚拟服务器被称为VPS（Virtual Private Serve），每个VPS的运行环境和独立服务器完全一致。OpenVZ基于Linux系统内核及作业系统提供操作系统级虚拟化，在虚拟化过程中资源消耗非常小，官方宣称约1-2%。
- **Hyper-V**： 是微软件推出的一种虚拟化技术，可以采用半虚拟化或全虚拟的方式创建虚拟机。虽然它可以创建Windows或Linux操作系统，但其本身只能运行在Windows系统下，使用范围较为有限。
- **Oracle VM** ：Oracle推出的服务器虚拟化软件，基于开源的Xen技术，包括Oracle VM Server和Oracle VM Manager两部分。
- **VMWare** ：是一家非常出名虚拟化软件公司，其产品涵盖服务器、桌面等各种虚拟化领域，如：**VMware Workstation** ，是一款桌面虚拟机软件，可以在一台实体机器上模拟完整的网络环境，并可运行多个Windows、DOS、Linux或Mac系统，是非常好的开发、测试、部署解决方案。从技术角度来说，VMware Workstation是一款完全虚拟化产品，可借助硬件辅助在不修改用户操作系统的情况下完整虚拟化操作系统。
- **VMware ESX Server**： 是一款适用于任何系统环境的企业级的虚拟机软件，可以认为是VMware Server的升级版。相比VMware Workstation来说，其功能更加强大，可以用于构建高伸缩和高可靠企业级服务器，并可实现远程管理、高级资源管理控制等高级功能。

## Docker虚拟化

### 什么是Docker？

Docker是一个开源的应用容器引擎，它让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到安装了任何 Linux 发行版本的机器上。Docker基于LXC来实现类似VM的功能，可以在更有限的硬件资源上提供给用户更多的计算资源。与同VM等虚拟化的方式不同，LXC不属于全虚拟化、部分虚拟化或半虚拟化中的任何一个分类，而是一个操作系统级虚拟化。

Docker是直接运行在宿主操作系统之上的一个容器，使用沙箱机制完全虚拟出一个完整的操作，容器之间不会有任何接口，从而让容器与宿主机之间、容器与容器之间隔离的更加彻底。每个容器会有自己的权限管理，独立的网络与存储栈，及自己的资源管理能，使同一台宿主机上可以友好的共存多个容器。

Docker借助Linux的内核特性，如：控制组（Control Group）、命名空间（Namespace）等，并直接调用操作系统的系统调用接口。从而降低每个容器的系统开销，并实现降低容器复杂度、启动快、资源占用小等特征。

### Docker能干什么？

**简化配置**

这是Docker公司宣传的Docker的主要使用场景。虚拟机的最大好处是能在你的硬件设施上运行各种配置不一样的平台（软件、系统），Docker在降低额外开销的情况下提供了同样的功能。它能让你将运行环境和配置放在代码中然后部署，同一个Docker的配置可以在不同的环境中使用，这样就降低了硬件要求和应用环境之间耦合度。

**代码流水线（Code Pipeline）管理**

前一个场景对于管理代码的流水线起到了很大的帮助。代码从开发者的机器到最终在生产环境上的部署，需要经过很多的中间环境。而每一个中间环境都有自己微小的差别，Docker给应用提供了一个从开发到上线均一致的环境，让代码的流水线变得简单不少。

**提高开发效率**

这就带来了一些额外的好处：Docker能提升开发者的开发效率。

不同的开发环境中，我们都想把两件事做好。一是我们想让开发环境尽量贴近生产环境，二是我们想快速搭建开发环境。

理想状态中，要达到第一个目标，我们需要将每一个服务都跑在独立的虚拟机中以便监控生产环境中服务的运行状态。然而，我们却不想每次都需要网络连接，每次重新编译的时候远程连接上去特别麻烦。这就是Docker做的特别好的地方，开发环境的机器通常内存比较小，之前使用虚拟的时候，我们经常需要为开发环境的机器加内存，而现在<u>Docker可以轻易的让几十个服务在Docker中跑起来</u>。

**隔离应用**

有很多种原因会让你选择在一个机器上运行不同的应用，比如之前提到的提高开发效率的场景等。

我们经常需要考虑两点，一是因为要降低成本而进行服务器整合，二是将一个整体式的应用拆分成松耦合的单个服务（微服务架构）。

**整合服务器**

正如通过虚拟机来整合多个应用，Docker隔离应用的能力使得Docker可以整合多个服务器以降低成本。由于没有多个操作系统的内存占用，以及能在多个实例之间共享没有使用的内存，Docker可以比虚拟机提供更好的服务器整合解决方案。

**调适能力**

Docker提供了很多的工具，这些工具不一定只是针对容器，但是却适用于容器。它们提供了很多的功能，包括可以为容器设置检查点、设置版本和查看两个容器之间的差别，这些特性可以帮助调试Bug。

**多租户**

另外一个Docker有意思的使用场景是在多租户的应用中，它可以避免关键应用的重写。我们一个特别的关于这个场景的例子是为IoT（物联网）的应用开发一个快速、易用的多租户环境。这种多租户的基本代码非常复杂，很难处理，重新规划这样一个应用不但消耗时间，也浪费金钱。

使用Docker，可以为每一个租户的应用层的多个实例创建隔离的环境，这不仅简单而且成本低廉，当然这一切得益于Docker环境的启动速度和其高效的diff命令。

**快速部署**

在虚拟机之前，引入新的硬件资源需要消耗几天的时间。Docker的虚拟化技术将这个时间降到了几分钟，Docker只是创建一个容器进程而无需启动操作系统，这个过程只需要秒级的时间。这正是Google和Facebook都看重的特性。

你可以在数据中心创建销毁资源而无需担心重新启动带来的开销。通常数据中心的资源利用率只有30%，通过使用Docker并进行有效的资源分配可以提高资源的利用率。

## Docker和虚拟机的区别？

> 虚拟机Virtual Machine与容器化技术（代表Docker）都是虚拟化技术，两者的区别在于虚拟化的程度不同。

### 基本对比

![img](http://image.edkso.cn/blog/docker-y-0.jpg)

- **虚拟机**
  - 基础设施（Infrastructure）：他可以是你的个人电脑，数据中心的服务器，或者是云主机
  - 主操作系统（Host Operating System）：你的个人电脑之上，运行的可能是MACOS、Windows或者某个Linux发行版
  - 虚拟机管理系统（Hypervisor）：利用虚拟机管理系统，可以在主操作系统之上运行多个不同的从操作系统
  - 操作系统（Guest Operating System）：假设你需要运行3个相互隔离的应用，则需要使用虚拟机管理系统启动3个从操作系统，也就是3个虚拟机，这些虚拟机都非常大，也许有700MB，这就意味着他们将占用2.1GB的磁盘空间，更糟糕的是它们还会消耗很多CPU和内存
  - 各种依赖：每一个操作系统都需要安装许多依赖，如果你的应用需要连接关系型数据库的话可能需要安装MySQL，如果你需要使用开发语言的话，比如JAVA则需要安装对应的JVM虚拟机
- **Docker容器**
  - 主操作系统（Host Operating System）：所有主流的Linux发行版都可以运行Docker，对于MacOS和Windows，也有一些办法运行Docker
  - Docker守护进程（Docker Daemon）：Docker守护进程取代了Hypervisor，它是运行在操作系统之上的后台进程，负责管理Docker容器
  - 各种依赖：对于Docker，应用的所有依赖都打包在Docker镜像中，Docker容器是基于Docker镜像创建的
  - 应用：应用的段代码与它的由来都打包在Docker镜像中，不同的应用则需要不同的Docker镜像，不同的应用运行在不同的Docker容器中，他们是相互隔离的。

虚拟机是在物理资源层面实现的隔离，相对于虚拟机，Docker是你APP层面实现的隔离，并省去了虚拟操作系统（Guest OS），从而节省了一部分的系统资源。

Docker守护进程可以直接与主操作系统进行通信，为各个Docker容器分配资源；它还可以将容器与主操作系统隔离吗，并将各个容器相互隔离。

虚拟机启动需要数分钟，而Docker容器可以在数毫秒内启动，由于没有臃肿的从操作系统，Docker可以节省大量的磁盘空间以及其他系统资源。



### 虚拟技术对比

#### **隔离性**

在于隔离性上面，由于vm对操作系统也进行了虚拟化，隔离的更加彻底；而Docker共享宿主机的操作系统，隔离性较差。

#### 运行效率

由于vm的隔离操作，导致生成虚拟机的速率大大低于容器Docker生成的速度，因为Docker直接利用宿主机的系统内核。比如openstack能够以10台/min的速度创建虚拟机，而docker可以做到在几秒钟之内创建大量容器，它们的启动速度是在数量级上的差距。

因为虚拟机增加了一层虚拟硬件层，运行在虚拟机上的应用程序在进行数值计算时是运行在Hypervisor虚拟的CPU上的；另外一方面是由于计算程序本身的特性导致的差异。<u>虚拟机虚拟的CPU</u>架构不同于实际cpu架构，数值计算程序一般针对特定的CPU（物理CPU）架构有一定的优化措施，虚拟化使这些措施作废，甚至起到反效果。

#### 资源利用率

在资源利用率上，虚拟机由于隔离更彻底，因此利用率也会相对较低，而Dcoker没有虚拟操作系统本身占用的系统资源，资源利用率更高。

## 参考文章

- https://blog.csdn.net/steelren/article/details/78491923
- https://www.cnblogs.com/jie-fang/p/10279629.html